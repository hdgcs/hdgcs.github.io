---
title:     '我的 NAS 家庭存储方案'
tags:      [NAS]
---

我使用 NAS 的初衷是更好解决 “家庭影音” 和 “家庭相册” 问题。最终除了很好的解决了这两个需求，还提供了一些额外的价值，比如多了一个超大网盘、可靠的文件备份、多设备文件同步、方便运行各类程序等。以下是我详细的 NAS 方案。

## 设备选购

首先是硬件设备的选购，主要包含 NAS 服务器和硬盘。

NAS 品牌可以网上搜一些优缺点，根据自己需求进行选择。然后选具体型号主要看需要多少盘位，这个决定你的服务器支持的最大空间容量。还一个可以考虑支持 Docker 技术，有了它就多了运行很多服务的可能性。

硬盘选购的注意点一个是需要企业级，保证质量和寿命。另外一个就是在价格能接受的范围内尽可能选大点的，能为后面提供余量，另外一般越大速度也越快。

我当时也是入门用户，尽量在满足自己需求的情况下节省成本，具体搭配是：
- 群晖 DS220+ (两盘位)
- 西数 HC550 18T * 2

## 家庭影音

首先是看剧需求的解决，因为忍受不了各大视频网站的会员和不一致的体验，在有了 36T 家庭存储的基础上，希望自己搭建一套影音平台，供家里电视等设备使用，甚至分享给亲朋好友观看。

对于一套影音平台的搭建，主要是两个问题要解决：
- 如何下载视频
- 如果整合视频

### 如何下载视频

对于如何下载视频，主要需要找到：
- 丰富资源的平台
- 速度要快操作简单的下载工具

资源平台可以去搜索 PT 分享网站，注册或找朋友要一个账户，然后下载资源。

对于下载工具可以选择：
- Download Station (群晖自带，简单方便)
- qBittorrent (用户多，下载速度更快)

### 如何整合视频

整合视频主要需要解决：视频的自动分类、自动为资源生成封面和简介、在线字幕等问题。这个没什么好说的，可以直接通过钞能力解决，比如我的方案：
- Apple TV 电视盒子
- Infuse 软件

我家原本是小米电视，由于硬件和系统限制，没有很好的影音软件，现在这个电视直接当成一个显示器用，播放 Apple TV 的内容。

Infuse 软件是一个 Apple 生态下的家庭影音软件，视频的自动分类、自动为资源生成封面和简介、在线字幕等问题都直接帮你解决了，你要做的就是下载好视频即可。

你需要注意下资源的命名，因为它就是通过名称在线进行匹配视频信息和字幕的。不过一般的资源都是标准命名，因此很少需要我们手动修改。

## 家庭相册

对于手机相册问题，不知道你有没有被这些问题苦恼过：
- 换过多个手机设备，曾经的相册丢了
- 相片视频越来越大，手机存储又很贵，比如黄金存储的 iPhone
- 手机厂商的云服务很贵，且以后也不方便更换品牌

相册的意义还是很大的，很多早年的照片很有纪念价值，但是却被我们弄丢了。为了解决这些问题，我分享下自己当前对于家庭相册的解决方案：
1. 首先手机的相册只作为临时存储，使用 NAS 云相册配置好自动备份，再也不怕更换手机。
1. 查看相册直接使用 NAS 云相册，再早的相片也存在，且不占用手机存储。
1. 手机存储不够时，直接批量删除本地相册即可。再也不用为了大容量使劲加钱了。
1. 将家庭照片移动到 “共享空间”，方便家庭成员一同查看。当爸妈的可以使劲给娃拍照了。

手机空间当前还是论 GB 算，我们的 NAS 可是论 TB 算，已经垮了一个量级。

## 同步网盘

同步网盘能够保证多设备的文档一致，比如公司家里有两台电脑，就可以设置一个同步目录，里面的文档就是本地文件，但是任何修改都能同步到另一台设备里。当然你的移动设备也同样可以添加上同步功能。

在群晖(7.x)中主要是通过 [Synology Drive](https://kb.synology.cn/zh-cn/DSM/tutorial/How_to_set_up_connection_to_Drive) 软件来实现的，群晖的产品体验还是很好的，步骤很简单：
1. 在群晖服务端配置支持同步的文件夹，打开 “Synology Drive 管理控制台” 启用即可
2. 在你的客户端安装网盘软件并设置好同步任务

比如我们在公司工作到一半，文档存储在 `/homes/songhuang/notes` 目录，希望在家用个人电脑继续处理，这时候只需要给两台电脑同时配置上：
云端目录 `/homes/songhuang/notes` -> 本地目录 `/homes/songhuang/notes`

记得 `homes` 根目录需要提前在 “Synology Drive 管理控制台” 启用，最后两个客户端都设置为双向同步即可。

## 外网访问

上面不管是我们搭建的家庭影音还是家庭相册，都需要能在外网环境下使用，对于外网访问有两种方案：
|方案|优点|缺点|
|---|---|---|
|自带中继方案|简单便捷|网络需要中转会慢一些|
|DDNS 直连方案|网络直连更快|配置复杂|

### 自带中继方案

如果不想折腾就直接用很多 NAS 服务器都提供的中继方案，像群晖(7.x)直接在 "控制面板" -> "外部访问" -> "QuickConnect" 中启用功能即可，会给你生成一个域名供你外网使用。

### DDNS 直连方案

如果你愿意折腾，对网络要求高，可以使用 DDNS 直连方案，这个方案需要处理以下问题：
1. 确保宽带支持外网 IP
2. 需要一个网站域名
3. 使用 DDNS 服务，将你的网站域名定期解析到你宽带的外网 IP 上
4. 配置上述域名地址的 SSL 证书，让外网访问更安全，并去除很多客户端的警告

首先由于 IPv4 短缺，很多宽带不会自带外网 IP 地址，可能需要额外申请，比如电信宽带请拨打 10000 询问。

对于 DDNS 服务，可以直接使用 NAS 服务器的功能，比如群晖(7.x)的 "控制面板" -> "外部访问" -> "DDNS"。DDNS 技术原理就是在你的宽带环境中，定时检测外网 IP 地址的变化，通过调用 DNS 服务商 API，更新域名的 DNS 解析。家庭宽带中，我们的外网 IP 是有可能会变动的，需要定时更新域名解析。

对于 SSL 证书问题，我是通过群晖(7.x)的反向代理服务器解决的，包括以下步骤：
1. 为你的网站域名申请一个 SSL 证书，域名服务商一般会提供免费的证书
2. 在群晖上添加 SSL 证书，配置路径："控制面板" -> "安全性" -> "证书"，并设置为默认证书
3. 配置反向代理转发外部请求，配置路径："控制面板" -> "登录门户" -> "高级" -> "反向代理服务器"（比如你配置了 https://domain.com:15000 到你内网的 DSM 地址 10.0.0.2:5000）
4. 配置路由器的虚拟服务器，将外网端口转发到群晖系统的内网 IP 地址（比如上面的配置对应：外网15000 -> 内网 10.0.0.2:15000）

网络图大致为：
![DDNS](/assets/img/nas-ddns.png)

群晖 DSM 服务就是后台管理入口服务，浏览器登录该地址后可以使用所有功能，包括设置群晖以及使用云相册、网盘应用等，因此外网访问第一步就是暴露这个服务。

上述步骤中需要转发两次，我们可能有疑问为什么不直接在路由器上转发到 DSM 服务地址 10.0.0.2:5000，这是因为我们需要用到 NAS 的 SSL 证书功能，因此仍需要在群晖上多做一层转发。

还有关于端口的使用，太多端口了记不住，能否外网也统一用服务默认端口比如 DSM 的 5000？其实也是可以的，只需要把上述步骤 4 中的 "外网15000" 改成 "外网5000" 即可。但一般会使用不同端口，原因主要有：
- 外网环境复杂且不安全，很多针对特定端口进行扫描攻击的工具，如果你的 DSM 服务外网也是用的默认端口5000，则更容易遭受攻击。
- 除了 DSM 服务以外，后续还有很多其他的内网服务，他们的默认端口一般是四位数且比较简单，很多端口可能已经被宽带商屏蔽了(比如 8080)，因此最好外网端口使用更复杂的五位数。

端口的对应关系可以考虑指定一种算法喽，比如内网 -> 1+内网，像 DSM 的外网端口就是 15000。

## 数据安全

NAS 存储量很大且支持多个硬盘，硬盘是可能发生损坏的，我们应该利用它的空间做好数据冗余，保证重要数据的安全，包括相册、重要文档等。数据备份也有两种方案：

|方案|优点|缺点|
|---|---|---|
|RAID 方案|配置简单|硬盘级别备份，空间占用大|
|软件备份方案|可选择备份数据，空间占用小|配置复杂|

### RAID 方案

RAID 方案只需要第一次使用时，为多个硬盘配置上 RAID 方案即可。硬盘所有数据都会帮你冗余保护起来，防止突发硬盘损坏导致数据丢失的问题。

RAID 方案简单，所有数据一视同仁，如果你的 NAS 盘位多（4个以上），我建议使用这种方案，因为盘位越多利用率越高。具体操作的话群晖(7.x)是在 “存储管理器“ 中为硬盘创建 “存储池”，可以选用升级版的 SHR 类型，设置完后你硬盘的 1/4 容量将承担保护作用，不可用。

### 软件备份方案

我的 NAS 只有 2 个盘位，如果使用群晖默认的 SHR 方案，其中一半的空间需要留给保护空间，有点心疼，因此我使用的软件备份方案。

软件备份方案设置起来也没那么难，比如群晖(7.x)直接使用 [Hyper Backup](https://kb.synology.cn/zh-cn/DSM/tutorial/Quick_Start_Hyper_Backup) 软件支持配置支持备份多个源目录到目的目录，定时增量备份，我为以下重要目录设置了备份：
- homes: 用户数据，包含文档、个人相册等
- photo: 全局相册
- data: 公共重要数据

## 总结

以上就是我的 NAS 家庭存储方案，总结一下，主要包含以下方面：
![NAS](/assets/img/nas-summary.png)

NAS 能做的事情有很多，如果你的朋友也想体验下，你还可以直接给他开一个用户，设置好权限即可。

最后关于成本问题，借用一句话 “骑自行车去酒吧，该省省该花花”。两千的 NAS 可以，二十的视频会员不行！
